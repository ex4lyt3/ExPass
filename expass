#!/bin/bash

OPTION=$1

mainDir=~/test/.expass

#Check if files exist
if [ -d $mainDir ] && [ -d $mainDir/data ]  && [ -f $mainDir/verify_key ];
then
    echo " ________          _______ 
|        \\        |       \\
| ▓▓▓▓▓▓▓▓__    __| ▓▓▓▓▓▓▓\\ ______   _______  _______
| ▓▓__   |  \\  /  \\ ▓▓__/ ▓▓|      \ /       \/       \\
| ▓▓  \\   \\▓▓\/  ▓▓ ▓▓    ▓▓ \\▓▓▓▓▓▓\  ▓▓▓▓▓▓▓  ▓▓▓▓▓▓▓
| ▓▓▓▓▓    >▓▓  ▓▓| ▓▓▓▓▓▓▓ /      ▓▓\▓▓    \\ \\▓▓    \\
| ▓▓_____ /  ▓▓▓▓\\| ▓▓     |  ▓▓▓▓▓▓▓_\▓▓▓▓▓▓\\_\\▓▓▓▓▓▓\\
| ▓▓     \\  ▓▓ \\▓▓\\ ▓▓      \\▓▓    ▓▓       ▓▓       ▓▓
 \\▓▓▓▓▓▓▓▓\\▓▓   \\▓▓\\▓▓       \\▓▓▓▓▓▓▓\▓▓▓▓▓▓▓ \\▓▓▓▓▓▓▓
                                                v0.1"
else 
    echo "ExPass has not been set up. (Essential directories do not exist)"
    echo "Solution:"
    exit
fi

if [ $# == 0 ]
then 
    echo "No arguments supplied."
    exit
fi

#Check for password
verifyPassword()
{
    read -sp "Please enter your password " masterPassword
    keyHash=$(openssl enc -nosalt -aes-256-cbc -pbkdf2 -k $masterPassword -P | md5sum)
    verifyKey=$(cat $mainDir/verify_key)
    echo $verify_key
    if [[ $keyHash == $verifyKey ]]
    then
        echo "Password verified."
    else
        echo "Password incorrect. Please retry."
        exit
    fi
}

#Options
case $OPTION in
-e | --encrypt)
    #Encrypts
    echo "Hello nub"
    verifyPassword
    echo $masterPassword
    read -p "Enter a title for your password entry: " titleEntry
    read -sp "Enter the password for your new entry: " passwordEntry
    key=$(openssl enc -nosalt -aes-256-cbc -pbkdf2 -k $masterPassword -P | grep "key")
    iv=$(openssl enc -nosalt -aes-256-cbc -pbkdf2 -k $masterPassword -P | grep "iv") #EXTREMELY INEFFICIENT
    #Append entry in file
    exit
    ;;
-d | --decrypt)
    exit
    ;;
-s | -search)
    exit
    ;;
-l | --list)
    exit
    ;;
--decrypt-all)
    exit
    ;;
--help)
    exit
    ;;
*) 
    #If no arguments are supplied
    echo "Invalid option - '${OPTION}' detected"
    echo "--help for more information"
    exit
    ;;
esac